generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  ADMIN
  VIEWER
}

// ============================================
// CLIENT MANAGEMENT
// ============================================

model Client {
  id     String       @id @default(cuid())
  slug   String       @unique
  status ClientStatus @default(ACTIVE)

  // Business Info
  businessName  String
  contactPerson String?
  phone         String
  email         String
  streetAddress String
  city          String
  state         String
  postalCode    String
  country       String  @default("US")

  // Service Details
  hasShopLocation        Boolean  @default(true)
  offersMobileService    Boolean  @default(false)
  serviceAreas           String[] // Array of cities/neighborhoods
  insuranceRelationships String[]

  // Services Offered (for schema markup and content)
  offersWindshieldRepair      Boolean @default(true)
  offersWindshieldReplacement Boolean @default(true)
  offersSideWindowRepair      Boolean @default(false)
  offersBackWindowRepair      Boolean @default(false)
  offersSunroofRepair         Boolean @default(false)
  offersRockChipRepair        Boolean @default(true)
  offersAdasCalibration       Boolean @default(false)

  // Brand Settings
  logoUrl        String?
  primaryColor   String? @default("#1e40af")
  secondaryColor String? @default("#3b82f6")
  accentColor    String? @default("#f59e0b")
  brandVoice     String? @default("Professional, helpful, and knowledgeable")

  // WordPress Connection
  wordpressUrl         String?
  wordpressUsername    String?
  wordpressAppPassword String? // Encrypted
  wordpressConnected   Boolean @default(false)

  // CTA Configuration
  ctaText String  @default("Get a Free Quote")
  ctaUrl  String?

  // Video Generation Settings (Creatify)
  creatifyTemplateId   String? // Custom Creatify template UUID for branded videos
  creatifyAvatarId     String? // Override avatar ID (get from /api/creatify/avatars-voices)
  creatifyVoiceId      String? // Override voice ID (get from /api/creatify/avatars-voices)
  creatifyVisualStyle  String? // Visual style: AvatarBubbleTemplate, DynamicProductTemplate, etc.
  creatifyScriptStyle  String? // Script style: HowToV2, DiscoveryWriter, CallToActionV2, etc.
  creatifyModelVersion String? // Model: standard (cheapest), aurora_v1, aurora_v1_fast
  creatifyVideoLength  Int?    // Video length in seconds: 15, 30, 45, or 60 (default: 30)
  creatifyNoCta        Boolean @default(false) // Disable default CTA button (use script CTA instead)

  // Publishing Preferences (Tue/Thu schedule)
  preferredPublishTime String @default("09:00")
  timezone             String @default("America/Denver")

  // Social Media
  socialPlatforms      String[] // facebook, instagram, linkedin, twitter, tiktok, gbp
  socialAccountIds     Json? // { facebook: "lateId1", instagram: "lateId2", ... }
  disconnectedAccounts Json? // { facebook: { disconnectedAt: "ISO date", reason: "..." }, ... }

  // Client Portal
  portalPassword String? // Encrypted

  // Google Places / Maps
  googlePlaceId String? // Google Places API place_id
  googleMapsUrl String? // Direct link to Google Maps

  // WRHQ Directory
  wrhqDirectoryUrl String? // Link to WRHQ directory listing

  // GBP Data (for press releases)
  gbpPlaceId     String?
  gbpRating      Float?
  gbpReviewCount Int?

  // Podbean Podcast Association
  podbeanPodcastId    String? // Selected podcast ID from global Podbean account
  podbeanPodcastTitle String? // Cached podcast title for display
  podbeanPodcastUrl   String? // Public URL to the podcast page

  // WRHQ YouTube Playlist (for long-form video uploads)
  wrhqYoutubePlaylistId    String? // YouTube playlist ID for this client
  wrhqYoutubePlaylistTitle String? // Cached playlist title for display

  // Subscription Management
  subscriptionStatus    SubscriptionStatus @default(TRIAL)
  subscriptionPlan      SubscriptionPlan   @default(STARTER)
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  billingEmail          String?
  stripeCustomerId      String?
  stripeSubscriptionId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Calendar Generation
  calendarGenerated   Boolean   @default(false)
  calendarGeneratedAt DateTime?
  calendarEndDate     DateTime? // How far out the calendar is populated

  // Automation Settings
  autoScheduleEnabled   Boolean   @default(false) // Opt-in for automation
  autoScheduleFrequency Int       @default(2) // Posts per week (1 or 2)
  lastAutoScheduledAt   DateTime? // Track last automation run

  // Smart Scheduling (to avoid Late.dev 5-post-per-account limit)
  scheduleDayPair  String? // e.g., "MON_WED", "TUE_THU", "WED_FRI" - auto-assigned
  scheduleTimeSlot Int? // 0-9: morning slots 0-4 (7-11 AM local), afternoon slots 5-9 (1-5 PM local)

  // Relations
  contentItems     ContentItem[]
  blogPosts        BlogPost[]
  wrhqBlogPosts    WRHQBlogPost[]
  images           Image[]
  podcasts         Podcast[]
  videos           Video[]
  shortFormVideos  ShortFormVideo[]
  socialPosts      SocialPost[]
  pressReleases    PressRelease[]
  servicePages     ServicePage[]
  locationPages    LocationPage[]
  serviceLocations ServiceLocation[]
  clientPAAs       ClientPAA[]
  publishingLogs   PublishingLog[]

  // GBP Posting Service
  gbpPostConfig GBPPostConfig?
  gbpPosts      GBPPost[]

  // Leads & Client Portal
  leads           Lead[]
  clientUsers     ClientUser[]
  googleAdsConfig ClientGoogleAds?
}

enum ClientStatus {
  ACTIVE
  PAUSED
  ONBOARDING
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum SubscriptionPlan {
  STARTER // Basic plan
  GROWTH // Mid-tier
  ENTERPRISE // Full service
}

// ============================================
// CONTENT ITEMS (Master Record)
// ============================================

model ContentItem {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // PAA Question (link to client's PAA)
  clientPAAId String?
  clientPAA   ClientPAA? @relation(fields: [clientPAAId], references: [id])
  paaQuestion String // Rendered/final question text (with location substituted)
  topic       String? // AI-suggested topic category

  // Service Location (link to client location)
  serviceLocationId String?
  serviceLocation   ServiceLocation? @relation(fields: [serviceLocationId], references: [id])

  // Scheduling
  scheduledDate DateTime
  scheduledTime String   @default("09:00")
  priority      Int      @default(0)

  // Status
  status       ContentStatus @default(DRAFT)
  pipelineStep String? // Current step in pipeline
  retryCount   Int           @default(0)
  lastError    String?

  // Notes
  notes String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // ============================================
  // APPROVAL TRACKING
  // ============================================
  blogApproved          ApprovalStatus @default(PENDING)
  imagesApproved        ApprovalStatus @default(PENDING)
  socialApproved        ApprovalStatus @default(PENDING)
  wrhqBlogApproved      ApprovalStatus @default(PENDING)
  wrhqSocialApproved    ApprovalStatus @default(PENDING)
  podcastDescApproved   ApprovalStatus @default(PENDING)
  videoDescApproved     ApprovalStatus @default(PENDING)
  longformVideoApproved ApprovalStatus @default(PENDING)

  // ============================================
  // GENERATION STATUS
  // ============================================
  blogGenerated       Boolean @default(false)
  imagesGenerated     Boolean @default(false)
  socialGenerated     Boolean @default(false)
  wrhqBlogGenerated   Boolean @default(false)
  wrhqSocialGenerated Boolean @default(false)

  // ============================================
  // APPROVAL COUNTS (for multi-item approvals)
  // ============================================
  imagesApprovedCount     Int @default(0)
  imagesTotalCount        Int @default(0)
  socialApprovedCount     Int @default(0)
  socialTotalCount        Int @default(0)
  wrhqSocialApprovedCount Int @default(0)
  wrhqSocialTotalCount    Int @default(0)

  // ============================================
  // PUBLISHING STATUS
  // ============================================
  clientBlogPublished   Boolean   @default(false)
  clientBlogPublishedAt DateTime?
  clientBlogUrl         String?
  wrhqBlogPublished     Boolean   @default(false)
  wrhqBlogPublishedAt   DateTime?
  wrhqBlogUrl           String?
  socialPublished       Boolean   @default(false)
  socialPublishedAt     DateTime?

  // ============================================
  // MEDIA STATUS
  // ============================================
  podcastGenerated   Boolean   @default(false)
  podcastStatus      String? // 'generating', 'ready', 'approved', 'failed'
  podcastDescription String?
  podcastUrl         String? // Direct URL to podcast audio file
  podcastAddedToPost Boolean   @default(false)
  podcastAddedAt     DateTime?

  shortVideoGenerated   Boolean   @default(false)
  shortVideoStatus      String? // 'generating', 'ready', 'approved', 'failed'
  shortVideoDescription String?
  shortVideoAddedToPost Boolean   @default(false)
  shortVideoAddedAt     DateTime?

  longVideoUploaded    Boolean   @default(false)
  longformVideoUrl     String?
  longformVideoDesc    String?
  longVideoAddedToPost Boolean   @default(false)
  longVideoAddedAt     DateTime?

  // ============================================
  // SCHEMA STATUS
  // ============================================
  schemaGenerated   Boolean   @default(false)
  schemaUpdateCount Int       @default(0)
  schemaLastUpdated DateTime?

  // ============================================
  // DASHBOARD FLAGS
  // ============================================
  needsAttention    Boolean @default(false)
  completionPercent Int     @default(0)

  // Relations
  blogPost        BlogPost?
  wrhqBlogPost    WRHQBlogPost?
  images          Image[]
  podcast         Podcast?
  videos          Video[]
  shortFormVideos ShortFormVideo[]
  socialPosts     SocialPost[]
  wrhqSocialPosts WRHQSocialPost[]
  publishingLogs  PublishingLog[]

  @@index([clientId])
  @@index([status])
  @@index([scheduledDate])
  @@index([needsAttention])
  @@index([clientPAAId])
  @@index([serviceLocationId])
}

enum ContentStatus {
  DRAFT
  SCHEDULED
  GENERATING
  REVIEW // New - waiting for approval
  APPROVED // New - all items approved
  PUBLISHING
  PUBLISHED
  FAILED
  PAUSED
}

// Approval status for individual content pieces
enum ApprovalStatus {
  PENDING
  APPROVED
  NEEDS_REVISION
}

// ============================================
// BLOG POSTS
// ============================================

model BlogPost {
  id            String      @id @default(cuid())
  contentItemId String      @unique
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Content
  title   String
  slug    String
  content String // HTML content
  excerpt String?

  // SEO
  metaTitle       String?
  metaDescription String?
  focusKeyword    String?

  // WordPress
  wordpressPostId Int?
  wordpressUrl    String?
  featuredImageId Int?

  // Schema Markup
  schemaJson String? // Full JSON-LD schema graph

  // Stats
  wordCount Int?

  // Dates
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Linked Pages
  servicePageId   String?
  servicePage     ServicePage? @relation(fields: [servicePageId], references: [id])
  locationPageIds String[]
}

// ============================================
// WRHQ BLOG POSTS (for WindshieldRepairHQ.com directory)
// ============================================

model WRHQBlogPost {
  id            String      @id @default(cuid())
  contentItemId String      @unique
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Content
  title   String
  slug    String
  content String  @db.Text // HTML content
  excerpt String?

  // SEO
  metaTitle       String?
  metaDescription String?
  focusKeyword    String?

  // WordPress (WRHQ site)
  wordpressPostId  Int?
  wordpressUrl     String?
  featuredImageUrl String? // URL to the image used in the post

  // Stats
  wordCount Int?

  // Dates
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
}

// ============================================
// IMAGES
// ============================================

model Image {
  id            String      @id @default(cuid())
  contentItemId String
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Image Type
  imageType ImageType

  // File Info
  fileName String
  gcsUrl   String
  width    Int
  height   Int
  fileSize Int?

  // Alt Text
  altText String?

  // Approval
  approved   Boolean   @default(false)
  approvedAt DateTime?

  createdAt DateTime @default(now())
}

enum ImageType {
  BLOG_FEATURED // 1200x800
  FACEBOOK // 1200x630
  INSTAGRAM_FEED // 1080x1080
  INSTAGRAM_STORY // 1080x1920
  TWITTER // 1200x675
  LINKEDIN // 1200x627
  TIKTOK // 1080x1920
}

// ============================================
// PODCASTS
// ============================================

model Podcast {
  id            String      @id @default(cuid())
  contentItemId String      @unique
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Audio File
  audioUrl String
  duration Int? // seconds

  // Script
  script String?

  // Description (HTML for podcast platforms)
  description String? @db.Text

  // API Reference
  autocontentJobId String?

  // Podbean Publishing
  podbeanEpisodeId String?
  podbeanUrl       String?
  podbeanPlayerUrl String?

  // Status
  status MediaStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum MediaStatus {
  PENDING
  PROCESSING
  READY
  PUBLISHED
  FAILED
}

// ============================================
// VIDEOS
// ============================================

model Video {
  id            String      @id @default(cuid())
  contentItemId String
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Video Type
  videoType VideoType

  // File Info
  videoUrl     String
  thumbnailUrl String?
  duration     Int? // seconds
  aspectRatio  String? // 16:9, 9:16, 1:1

  // API Reference
  provider      VideoProvider
  providerJobId String?

  // Status
  status MediaStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum VideoType {
  SHORT // 60-90 seconds
  LONG // 3-5 minutes
}

enum VideoProvider {
  CREATIFY
  PICTORY
  MANUAL // For uploaded videos
}

// ============================================
// SHORT FORM VIDEOS (Multiple per content item)
// ============================================

model ShortFormVideo {
  id            String      @id @default(cuid())
  contentItemId String
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Video Info
  title        String?
  description  String?
  videoUrl     String
  thumbnailUrl String?
  duration     Int? // seconds
  aspectRatio  String  @default("9:16")

  // Platform Assignment
  platforms SocialPlatform[] // Can target multiple platforms

  // Scheduling
  scheduledDate DateTime?
  scheduledTime String? // "09:00", "13:00", "17:00"
  dayNumber     Int? // Which day in the schedule (1, 2, 3, etc.)
  slotNumber    Int? // Which slot in the day (1, 2, 3)

  // Late.dev References
  getlatePostIds Json? // { platform: postId } mapping

  // Approval
  approved   Boolean   @default(false)
  approvedAt DateTime?

  // Status
  status        SocialPostStatus @default(DRAFT)
  publishedUrls Json? // { platform: url } mapping

  // Order
  sortOrder Int @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([contentItemId])
  @@index([scheduledDate])
}

// ============================================
// SOCIAL POSTS
// ============================================

model SocialPost {
  id            String      @id @default(cuid())
  contentItemId String
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Platform
  platform SocialPlatform

  // Content
  caption      String
  hashtags     String[]
  firstComment String? // Link to blog post

  // Media
  mediaUrls String[]
  mediaType String? // image, video

  // Scheduling
  scheduledTime DateTime

  // getlate.dev Reference
  getlatePostId String?

  // Approval
  approved   Boolean   @default(false)
  approvedAt DateTime?

  // Status
  status       SocialPostStatus @default(DRAFT)
  publishedUrl String?
  errorMessage String? // Error message if post failed

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
}

// ============================================
// WRHQ SOCIAL POSTS (separate from client posts)
// ============================================

model WRHQSocialPost {
  id            String      @id @default(cuid())
  contentItemId String
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  // Platform
  platform SocialPlatform

  // Content
  caption      String
  hashtags     String[]
  firstComment String?

  // Media
  mediaUrls String[]
  mediaType String? // image, video

  // Scheduling
  scheduledTime DateTime

  // getlate.dev Reference
  getlatePostId String?

  // Approval
  approved   Boolean   @default(false)
  approvedAt DateTime?

  // Status
  status       SocialPostStatus @default(DRAFT)
  publishedUrl String?
  errorMessage String? // Error message if post failed

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
}

enum SocialPlatform {
  FACEBOOK
  INSTAGRAM
  LINKEDIN
  TWITTER
  TIKTOK
  GBP
  YOUTUBE
  BLUESKY
  THREADS
  REDDIT
  PINTEREST
  TELEGRAM
}

enum SocialPostStatus {
  DRAFT
  SCHEDULED
  PROCESSING // Sent to Late API, awaiting platform confirmation
  PUBLISHED
  FAILED
}

// ============================================
// PRESS RELEASES
// ============================================

model PressRelease {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Month
  month DateTime // First day of the month

  // Featured Content
  featuredPaaIds String[] // Top 3 PAAs from previous month

  // GBP Milestones
  newReviews    Int?
  totalReviews  Int?
  averageRating Float?

  // Content Stats
  blogPostsCount     Int?
  totalContentPieces Int?

  // Press Release Content
  headline String?
  content  String? // Full press release text

  // Status
  status PressReleaseStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PressReleaseStatus {
  DRAFT
  READY
  SUBMITTED
}

// ============================================
// SERVICE & LOCATION PAGES
// ============================================

model ServicePage {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Page Info
  title String
  url   String
  slug  String

  // Service Details
  serviceType String? // windshield-replacement, adas-calibration, rock-chip-repair, etc.
  keywords    String[]

  // Auto-detected or Manual
  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  blogPosts BlogPost[]
}

model LocationPage {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Page Info
  title String
  url   String
  slug  String

  // Location Details
  cityName     String
  neighborhood String?

  // Auto-detected or Manual
  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// PUBLISHING LOGS
// ============================================

model PublishingLog {
  id            String       @id @default(cuid())
  contentItemId String?
  contentItem   ContentItem? @relation(fields: [contentItemId], references: [id], onDelete: SetNull)
  clientId      String
  client        Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Action
  action String // blog_generate, image_generate, wordpress_publish, podcast_generate, etc.

  // Status
  status LogStatus

  // Details
  requestPayload String? // JSON
  responseData   String? // JSON
  errorMessage   String?

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationMs  Int?

  // Retry Info
  attemptNumber Int @default(1)
}

enum LogStatus {
  STARTED
  SUCCESS
  FAILED
  RETRYING
}

// ============================================
// STANDARD PAA QUESTIONS (Global templates)
// ============================================

model StandardPAA {
  id       String  @id @default(cuid())
  question String // Template with {location} placeholder
  priority Int // Order (1, 2, 3...)
  isActive Boolean @default(true)
  category String? // Optional category for organization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Clients using this standard PAA
  clientPaas ClientPAA[]

  @@index([priority])
  @@index([isActive])
}

// ============================================
// CLIENT PAA QUESTIONS (Custom + synced standard)
// ============================================

model ClientPAA {
  id       String  @id @default(cuid())
  clientId String
  client   Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  question String // Template with {location} placeholder
  priority Int // Custom PAAs: 1-999, Standard PAAs: 1000+
  isActive Boolean @default(true)

  // Link to standard PAA (null = custom PAA for this client only)
  standardPaaId String?
  standardPaa   StandardPAA? @relation(fields: [standardPaaId], references: [id], onDelete: SetNull)

  // Automation tracking
  usedAt    DateTime? // When this PAA was last used (null = never)
  usedCount Int       @default(0) // Total times used

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contentItems ContentItem[]

  @@index([clientId])
  @@index([priority])
  @@index([isActive])
  @@index([usedAt])
  @@index([standardPaaId])
}

// ============================================
// SERVICE LOCATIONS (Client-specific)
// ============================================

model ServiceLocation {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  city           String
  state          String
  neighborhood   String? // Optional: specific neighborhood
  isHeadquarters Boolean @default(false)
  isActive       Boolean @default(true)

  // Automation tracking
  lastUsedAt DateTime? // When this location was last used for content

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contentItems ContentItem[]

  @@unique([clientId, city, state, neighborhood])
  @@index([clientId])
  @@index([isActive])
  @@index([lastUsedAt])
}

// ============================================
// GBP POSTING SERVICE
// ============================================

model GBPPostConfig {
  id       String @id @default(cuid())
  clientId String @unique
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Schedule
  enabled       Boolean          @default(false)
  frequency     GBPPostFrequency @default(WEEKLY)
  preferredDays Int[] // 0=Sunday, 1=Monday, etc.
  preferredTime String           @default("10:00")

  // Link Rotation
  rotationLinks    Json? // Array of { url, label, type, weight? }
  currentLinkIndex Int   @default(0)

  // Content Settings
  postTopics   String[] // Optional topic suggestions
  includePromo Boolean  @default(true)
  includePhone Boolean  @default(true)

  // Google OAuth (for photo fetching from GBP)
  googleAccessToken  String? // Encrypted
  googleRefreshToken String? // Encrypted
  googleTokenExpiry  DateTime?
  googleAccountId    String? // GBP account ID from Google

  // Cached Photos from GBP
  cachedPhotos      Json? // Array of { url, thumbnailUrl, category, name }
  photosLastFetched DateTime?

  // AI Image Generation Option
  useAiGeneratedImages Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  posts GBPPost[]

  @@index([enabled])
}

model GBPPost {
  id       String        @id @default(cuid())
  clientId String
  client   Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  configId String
  config   GBPPostConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  // Content
  content     String         @db.Text
  photoUrl    String?
  photoSource GBPPhotoSource @default(GBP_PROFILE)
  ctaUrl      String?
  ctaType     GBPCtaType?

  // Link used (for rotation tracking)
  rotationLinkIndex Int?
  rotationLinkLabel String?

  // Status
  status       GBPPostStatus @default(DRAFT)
  scheduledFor DateTime?
  publishedAt  DateTime?

  // Late Integration
  latePostId      String?
  platformPostUrl String? // URL to view on GBP

  // Error tracking
  errorMessage String?
  retryCount   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([status])
  @@index([scheduledFor])
}

enum GBPPostFrequency {
  DAILY
  TWICE_WEEKLY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum GBPPhotoSource {
  GBP_PROFILE // Photo fetched from Google Business Profile
  AI_GENERATED // Photo generated via Nano Banana Pro
  UPLOADED // Manually uploaded
  CLIENT_IMAGES // From client's existing images
}

enum GBPCtaType {
  LEARN_MORE
  BOOK
  ORDER
  SHOP
  SIGN_UP
  CALL
}

enum GBPPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

// ============================================
// LEADS (from Google Ads via HighLevel)
// ============================================

model Lead {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Contact Info
  email     String?
  phone     String?
  firstName String?
  lastName  String?

  // Google Ads Tracking (critical for offline conversions)
  gclid  String? // Google Click ID - needed for offline conversion import
  gbraid String? // Google GBRAID for iOS 14+
  wbraid String? // Google WBRAID for web-to-app

  // UTM Parameters (from your tracking template)
  utmSource    String? // adwords
  utmMedium    String? // {adname}
  utmCampaign  String? // {campaignname}
  utmContent   String? // {adgroupname}
  utmKeyword   String? // {keyword}
  utmMatchtype String? // {matchtype}
  campaignId   String? // {campaignid}
  adGroupId    String? // {adgroupid}
  adId         String? // {creative}

  // Lead Source
  source         LeadSource @default(FORM)
  landingPageUrl String?
  referrerUrl    String?

  // Form Data (store any extra fields)
  formData Json? // { vehicleType: "truck", zipCode: "85001", message: "..." }
  formName String? // Which form submitted (e.g., "homepage-quote", "mobile-landing")

  // HighLevel Reference
  highlevelContactId String?

  // Lead Status (updated by client)
  status          LeadStatus @default(NEW)
  statusUpdatedAt DateTime?
  statusUpdatedBy String? // ClientUser ID who updated

  // Qualification
  qualified          Boolean? // null = not yet assessed
  qualifiedAt        DateTime?
  qualificationNotes String?

  // Sale Info (for offline conversion import)
  saleValue    Float? // Revenue amount if sold
  saleCurrency String    @default("USD")
  saleDate     DateTime?
  saleNotes    String?

  // Google Ads Sync Status
  enhancedConversionSent   Boolean   @default(false) // Email/phone sent to Google
  enhancedConversionSentAt DateTime?
  offlineConversionSent    Boolean   @default(false) // Sale data sent to Google
  offlineConversionSentAt  DateTime?
  googleSyncError          String? // Last sync error if any

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([status])
  @@index([gclid])
  @@index([email])
  @@index([createdAt])
  @@index([offlineConversionSent])
}

enum LeadSource {
  FORM // Quote form submission
  PHONE // Phone call (from HighLevel call tracking)
  CHAT // Live chat
  MANUAL // Manually entered
}

enum LeadStatus {
  NEW // Just received
  CONTACTED // Client reached out
  QUALIFIED // Confirmed good lead
  UNQUALIFIED // Not a good fit
  QUOTED // Quote sent
  SOLD // Converted to sale
  LOST // Lost to competitor or no response
}

// ============================================
// CLIENT USERS (Portal Login)
// ============================================

model ClientUser {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Auth
  email        String  @unique
  name         String?
  passwordHash String? // For password login (optional)

  // Magic Link
  magicLinkToken  String?   @unique
  magicLinkExpiry DateTime?

  // Session
  lastLoginAt DateTime?
  isActive    Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pushSubscriptions PushSubscription[]

  @@index([clientId])
  @@index([magicLinkToken])
}

// ============================================
// PUSH NOTIFICATIONS
// ============================================

model PushSubscription {
  id           String @id @default(cuid())
  clientUserId String
  clientUser   ClientUser @relation(fields: [clientUserId], references: [id], onDelete: Cascade)

  // Web Push subscription data
  endpoint String @unique
  p256dh   String // Public key for encryption
  auth     String // Auth secret

  // Device info (optional, for debugging)
  userAgent String?

  // Status
  isActive  Boolean   @default(true)
  lastUsed  DateTime?
  failCount Int       @default(0) // Track failed delivery attempts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientUserId])
  @@index([isActive])
}

// ============================================
// GOOGLE ADS INTEGRATION
// ============================================

model GoogleAdsConfig {
  id String @id @default(cuid())

  // OAuth App Credentials (from Google Cloud Console)
  oauthClientId     String? // Encrypted
  oauthClientSecret String? // Encrypted

  // MCC (Manager Account) OAuth - your agency account
  mccCustomerId String? // Your MCC customer ID (xxx-xxx-xxxx format)
  accessToken   String? // Encrypted
  refreshToken  String? // Encrypted
  tokenExpiry   DateTime?

  // Developer Token
  developerToken String? // Encrypted - from Google Ads API Center

  // Status
  isConnected Boolean   @default(false)
  lastSyncAt  DateTime?
  lastError   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Link clients to their Google Ads customer IDs (under your MCC)
model ClientGoogleAds {
  id       String @id @default(cuid())
  clientId String @unique
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Client's Google Ads Customer ID (under your MCC)
  customerId String // Format: xxx-xxx-xxxx

  // Conversion Actions (for offline import)
  leadConversionActionId String? // Conversion action for new leads
  saleConversionActionId String? // Conversion action for sales

  // Status
  isActive   Boolean   @default(true)
  lastSyncAt DateTime?
  lastError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
}

// ============================================
// SETTINGS
// ============================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String // Encrypted for sensitive values
  encrypted Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
